<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>D3 Test</title>
    <script src="./d3.js" charset="utf-8"></script>
    <script src="./topojson.js" charset="utf-8"></script>
    <script src="./datalist.js" charset="utf-8"></script>
</head>
<style>
    .tooltip {
        position: absolute;
        width: auto;
        height: auto;
        padding: 4px;
        font: 10px sans-serif;
        color: #fff;
        background: #333;
        -webkit-box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        -moz-box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        border-radius: 4px;
        visibility: hidden;
        text-align: center;
    }
</style>

<body>
    <!-- <button type = "button" onclick = "zoomin()">zoom in</button>
    <button type = "button" onclick = "zoomout()">zoom out</button>
    <button type = "button" onclick = "resetzoom()">reset zoom</button> -->

  <div id="reset">
    <button id="reset-button">reset</button>
  </div>
    <script type="text/javascript">
        var colorScale = d3.scaleOrdinal(d3.schemeSet1);
        var width = 1000;
        var height = 900;
        var scale = 1500;
        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

        var map = svg.append('g')
            .attr('id', 'map')
            .attr('transform', 'translate(' + 0 + ',' + 0 + ')')
            .on("click", clicked)

        var tooltip = d3.select("body")
          .append("div")
          .attr("class", "tooltip")
          .style("position", "absolute")
          .style("top", "70px")
          .style("left", "10px");

        let projection = d3.geoMercator()
            .center([135, 35])
            .translate([width / 2, height / 2])
            .scale(scale);
        let square = d3.symbol().type("diamond");
        let geoGenerator = d3.geoPath().pointRadius(0).projection(projection);
        let wait = []
        datalist.forEach((path) => {
            wait.push(d3.json(path));
        })
        Promise.all(wait).then(function (values) {
            var japangeo = topojson.feature(values[0], values[0].objects.japan);
            map.selectAll("path")
                .data(japangeo.features)
                .enter()
                .append("path")
                .attr("d", geoGenerator)
                .attr("stroke", "black")
                .attr("stroke-width", 1)
                .attr("fill", "#646464");
            values.shift();
            values.forEach((d) => {
                map.selectAll("path2")
                    .data(d.features)
                    .enter()
                    .append("path")
                    .attr("d", geoGenerator)
                    .attr("stroke", "white")
                    .attr("fill", "none")
                    .attr("stroke-width", 1);
                map.selectAll("path2")
                    .data(d.features.filter(d => d.geometry.type == "Point"))
                    .join("circle")
                    .attr("cx", d => {return projection(d.geometry.coordinates)[0];})
                    .attr("cy", d => {return projection(d.geometry.coordinates)[1];})
                    .attr("r", 0.5)
                    .attr("stroke", "#a9ceec")
                    .attr("stroke-width", 0.1)
                    .attr("fill", "#a9ceec")
                    .on("mouseover", function(d,i){
                      // ここで人身事故情報を表示できるようにする
                      tooltip.style("visibility", "visible").html(i.properties.name);
                    })
                    .on("mouseout", function(){
                      tooltip.style("visibility", "hidden");
                    });
            })
        })


        let zoom = d3.zoom()
            .scaleExtent([1, 10])
            .translateExtent([[0, 0], [width, height]])
            .on('zoom', handleZoom);

        d3.select('svg').call(zoom);

        function handleZoom(d) {
            d3.select('#map')
                .attr('transform', d.transform);
        }

        // function zoomin() {
        //     zoom.scaleBy(map, 2);
        // }
        d3.select("#reset")
              .on("click", resetted);

        function clicked(event, d){
              console.log("clicked")
              var zoomCenter = d3.pointer(event)
              var zoom = 10
              svg.selectAll("#map")
                .transition()
                .duration(1000)
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + zoom + ")translate(" + -zoomCenter[0] + "," + -zoomCenter[1] + ")");
        }

        function resetted(event, d){
              svg.selectAll("#map")
                .transition()
                .duration(1000)
                .attr("transform", "translate(0,0)");
        }

        // function zoomout() {
        //     zoom.scaleBy(map, 0.5);
        // }
        
        // function resetzoom() {
        //     map.call(zoom.transform, d3.zoomIdentity);
        // }

    </script>
</body>

</html>
